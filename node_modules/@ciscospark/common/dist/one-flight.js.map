{"version":3,"sources":["../src/one-flight.js"],"names":["oneFlight","W","M","WeakMappedMappedMap","flights","params","length","oneFlightDecorator","options","cacheFailures","cacheSuccesses","keyFactory","target","prop","descriptor","key","value","oneFlightExecutor","fn","args","flight","get","message","logger","info","console","catch","reason","delete","reject","then","result","set","prototype"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;kBAuBwBA,S;;AAjBxB;;;;;;AAEA;AARA;;;;;AASA,IAAMC,qBAAN;AACA,IAAMC,iBAAN;AACA,IAAMC,sBAAsB,iCAAKF,CAAL,EAAQC,CAAR,EAAWA,CAAX,CAA5B;;AAEA,IAAME,UAAU,IAAID,mBAAJ,EAAhB;;AAEA;;;;;;;;AAQe,SAASH,SAAT,GAA8B;AAAA,oCAARK,MAAQ;AAARA,UAAQ;AAAA;;AAC3C,MAAIA,OAAOC,MAAP,KAAkB,CAAtB,EAAyB;AACvB,WAAO,qBAAcC,kBAAd,EAAkC,IAAlC,EAAwCF,MAAxC,CAAP;AACD;;AAED,MAAMG,UAAUH,OAAO,CAAP,KAAa,EAA7B;;AAL2C,MAQzCI,aARyC,GAWvCD,OAXuC,CAQzCC,aARyC;AAAA,MASzCC,cATyC,GAWvCF,OAXuC,CASzCE,cATyC;AAAA,MAUzCC,UAVyC,GAWvCH,OAXuC,CAUzCG,UAVyC;;;AAa3C,SAAOJ,kBAAP;;AAEA;;;;;;;AAOA,WAASA,kBAAT,CAA4BK,MAA5B,EAAoCC,IAApC,EAA0CC,UAA1C,EAAsD;AACpD,QAAIC,MAAMF,IAAV;AACAC,eAAWE,KAAX,GAAmB,oBAAKF,WAAWE,KAAhB,EAAuB,SAASC,iBAAT,CAA2BC,EAA3B,EAAwC;AAAA;;AAAA,yCAANC,IAAM;AAANA,YAAM;AAAA;;AAChF,UAAIR,UAAJ,EAAgB;AACdI,cAAMJ,4BAAcQ,IAAd,CAAN;AACD;;AAED;AACA,UAAIC,SAAShB,QAAQiB,GAAR,CAAY,IAAZ,EAAkBT,MAAlB,EAA0BG,GAA1B,CAAb;AACA,UAAIK,MAAJ,EAAY;AACV,YAAME,+CAA6CT,IAA7C,+CAAN;AACA;AACA,YAAI,QAAQ,KAAKU,MAAjB,EAAyB;AACvB,eAAKA,MAAL,CAAYC,IAAZ,CAAiBF,OAAjB;AACD,SAFD,MAGK;AACH;AACAG,kBAAQD,IAAR,CAAaF,OAAb;AACD;AACD,eAAOF,MAAP;AACD;;AAEDA,eAAS,qBAAcF,EAAd,EAAkB,IAAlB,EAAwBC,IAAxB,CAAT;AACA,UAAI,CAACV,aAAD,IAAkBW,MAAlB,IAA4BA,OAAOM,KAAvC,EAA8C;AAC5CN,iBAASA,OAAOM,KAAP,CAAa,UAACC,MAAD,EAAY;AAChCvB,kBAAQwB,MAAR,QAAqBhB,MAArB,EAA6BG,GAA7B;AACA,iBAAO,kBAAQc,MAAR,CAAeF,MAAf,CAAP;AACD,SAHQ,CAAT;AAID;;AAED,UAAI,CAACjB,cAAD,IAAmBU,MAAnB,IAA6BA,OAAOU,IAAxC,EAA8C;AAC5CV,iBAASA,OAAOU,IAAP,CAAY,UAACC,MAAD,EAAY;AAC/B3B,kBAAQwB,MAAR,QAAqBhB,MAArB,EAA6BG,GAA7B;AACA,iBAAOgB,MAAP;AACD,SAHQ,CAAT;AAID;;AAED3B,cAAQ4B,GAAR,CAAY,IAAZ,EAAkBpB,MAAlB,EAA0BG,GAA1B,EAA+BK,MAA/B;;AAEA,aAAOA,MAAP;AACD,KAtCkB,CAAnB;;AAwCA;AACA;AACA,QAAI,OAAOR,MAAP,iBAA8B,CAACA,OAAOqB,SAA1C,EAAqD;AACnDrB,aAAOC,IAAP,IAAeC,WAAWE,KAA1B;AACD;;AAED,WAAOF,UAAP;AACD;AACF","file":"one-flight.js","sourcesContent":["/**!\n *\n * Copyright (c) 2015-2016 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {wrap} from 'lodash';\nimport make from './template-container';\n\n// Alias Map and WeakMap to get around a babel compiler bug\nconst W = WeakMap;\nconst M = Map;\nconst WeakMappedMappedMap = make(W, M, M);\n\nconst flights = new WeakMappedMappedMap();\n\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\nexport default function oneFlight(...params) {\n  if (params.length === 3) {\n    return Reflect.apply(oneFlightDecorator, null, params);\n  }\n\n  const options = params[0] || {};\n\n  const {\n    cacheFailures,\n    cacheSuccesses,\n    keyFactory\n  } = options;\n\n  return oneFlightDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function oneFlightDecorator(target, prop, descriptor) {\n    let key = prop;\n    descriptor.value = wrap(descriptor.value, function oneFlightExecutor(fn, ...args) {\n      if (keyFactory) {\n        key = keyFactory(...args);\n      }\n\n      /* eslint no-invalid-this: [0] */\n      let flight = flights.get(this, target, key);\n      if (flight) {\n        const message = `one flight: attempted to invoke ${prop} while previous invocation still in flight`;\n        /* instanbul ignore else */\n        if (this && this.logger) {\n          this.logger.info(message);\n        }\n        else {\n          /* eslint no-console: [0] */\n          console.info(message);\n        }\n        return flight;\n      }\n\n      flight = Reflect.apply(fn, this, args);\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch((reason) => {\n          flights.delete(this, target, key);\n          return Promise.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then((result) => {\n          flights.delete(this, target, key);\n          return result;\n        });\n      }\n\n      flights.set(this, target, key, flight);\n\n      return flight;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === `object` && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"]}